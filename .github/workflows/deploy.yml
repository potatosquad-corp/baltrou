name: Release on Version Change

on:
  push:
    branches:
      - main # Surveille uniquement la branche principale

permissions:
  contents: write # N√©cessaire pour cr√©er le tag et la release

jobs:
  check-and-release:
    runs-on: ubuntu-latest
    steps:
      # 1. R√©cup√©rer tout l'historique pour pouvoir v√©rifier les tags existants
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      # 2. Installer pnpm
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9
          run_install: false

      # 3. Installer Node
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      # 4. C≈íUR DU SYST√àME : V√©rification de version
      - name: Check Version & Tag
        id: check
        run: |
          # Lire la version dans package.json
          VERSION=$(node -p "require('./package.json').version")
          TAG="v$VERSION"
          echo "Version actuelle dans package.json : $TAG"
          
          # V√©rifier si ce tag existe d√©j√† dans git
          if git rev-parse "refs/tags/$TAG" >/dev/null 2>&1; then
            echo "üõë Le tag $TAG existe d√©j√†. Aucune action requise."
            echo "do_release=false" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ Nouvelle version d√©tect√©e ! Lancement de la release..."
            echo "do_release=true" >> $GITHUB_OUTPUT
            echo "RELEASE_TAG=$TAG" >> $GITHUB_ENV
            
            # Cr√©er et pousser le tag imm√©diatement
            git config --global user.name 'GitHub Actions'
            git config --global user.email 'actions@github.com'
            git tag $TAG
            git push origin $TAG
          fi

      # 5. Installation & Build (Seulement si nouvelle version)
      - name: Install & Build
        if: steps.check.outputs.do_release == 'true'
        run: |
          pnpm install --frozen-lockfile
          
          # Cr√©ation d'un .env vide pour satisfaire le build SvelteKit si besoin
          cp .env.example .env
          
          pnpm run build
          
          # Cr√©ation de l'archive pour le d√©ploiement
          tar -czf release.tar.gz build package.json .env

      # 6. Cr√©ation de la Release GitHub (Seulement si nouvelle version)
      - name: Create Release
        if: steps.check.outputs.do_release == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: Release ${{ env.RELEASE_TAG }}
          files: release.tar.gz
          token: ${{ secrets.GITHUB_TOKEN }}
          draft: false
          prerelease: false
          # GitHub enverra automatiquement le webhook √† votre serveur une fois la release publi√©e